left_join(catholic,by=c("SA2_CODE_2021"="Census_Code")) %>%
sf::st_transform('+proj=longlat +datum=WGS84') %>%
leaflet() %>%
addTiles() %>%
addPolygons(stroke = FALSE, smoothFactor = 0.3, fillOpacity = 0.8,
color ="white", weight=10,
fillColor = ~pal(Percentage),
label = ~paste0(SA2_NAME_2021, ": ", formatC(Percentage, big.mark = ","),"%")) %>%
addLegend(pal = pal, values = ~Percentage, opacity = 1.0)
map
suburb <- get_map(filters = list(SAL_NAME_2021="Mount Waverley"),
year=2021,
aggregation = "SA1_NAME_2021")
source("~/GitHub/aussiemaps/R/get_map.R")
source("~/GitHub/aussiemaps/R/get_map.R")
suburb <- get_map(filters = list(SAL_NAME_2021="Mount Waverley"),
year=2021,
aggregation = "SA1_NAME_2021")
source("~/GitHub/aussiemaps/R/get_map.R")
suburb <- get_map(filters = list(SAL_NAME_2021="Mount Waverley"),
year=2021,
aggregation = "SA1_NAME_2021")
suburb
View(suburb)
catholic_burb <- get_census_summary("14",geo_structure="SA2",
attribute = list(Catholic =c("Christianity_catholic_persons")),
geo_unit_codes = suburb$SA1_CODE_2021,
reference_total = list("Total"="Total_persons"),
selected_years = "2021",
percentage_scale = 100
)
map2 <-suburb %>%
left_join(catholic_burb,by=c("SA1_CODE_2021"="Census_Code")) %>%
sf::st_transform('+proj=longlat +datum=WGS84') %>%
leaflet() %>%
addTiles() %>%
addPolygons(stroke = FALSE, smoothFactor = 0.3, fillOpacity = 0.8,
color ="white", weight=10,
fillColor = ~pal(Percentage),
label = ~paste0(SA1_NAME_2021, ": ", formatC(Percentage, big.mark = ","),"%")) %>%
addLegend(pal = pal, values = ~Percentage, opacity = 1.0)
map2 <-suburb %>%
left_join(catholic_burb,by=c("SA1_CODE_2021"="Census_Code")) %>%
sf::st_transform('+proj=longlat +datum=WGS84') %>%
leaflet() %>%
addTiles() %>%
addPolygons(stroke = FALSE, smoothFactor = 0.3, fillOpacity = 0.8,
color ="white", weight=10,
fillColor = ~pal(Percentage),
label = ~paste0(SA1_CODE_2021, ": ", formatC(Percentage, big.mark = ","),"%")) %>%
addLegend(pal = pal, values = ~Percentage, opacity = 1.0)
map2
catholic_burb <- get_census_summary("14",geo_structure="SA1",
attribute = list(Catholic =c("Christianity_catholic_persons")),
geo_unit_codes = suburb$SA1_CODE_2021,
reference_total = list("Total"="Total_persons"),
selected_years = "2021",
percentage_scale = 100
)
catholic_burb <- get_census_summary("14",geo_structure="SA1",
attribute = list(Catholic =c("Christianity_catholic_persons")),
geo_unit_codes = suburb$SA1_CODE_2021,
reference_total = list("Total"="Total_persons"),
selected_years = "2021",
percentage_scale = 100
)
map2 <-suburb %>%
left_join(catholic_burb,by=c("SA1_CODE_2021"="Census_Code")) %>%
sf::st_transform('+proj=longlat +datum=WGS84') %>%
leaflet() %>%
addTiles() %>%
addPolygons(stroke = FALSE, smoothFactor = 0.3, fillOpacity = 0.8,
color ="white", weight=10,
fillColor = ~pal(Percentage),
label = ~paste0(SA1_CODE_2021, ": ", formatC(Percentage, big.mark = ","),"%")) %>%
addLegend(pal = pal, values = ~Percentage, opacity = 1.0)
map2
catholic_burb <- get_census_summary("14",geo_structure="SA1",
attribute = list(Catholic =c("Christianity_catholic_persons")),
geo_unit_codes = suburb$SA1_CODE_2021,
reference_total = list("Total"="Total_persons"),
selected_years = "2021",
percentage_scale = 100
)
source("~/GitHub/aussiemaps/data-raw/tests.R")
devtools::document()
pkgdown::build_site()
library(aussiemaps)
filters=list("SAL_NAME_2021"=c("Frankston",
"Frankston South",
"Frankston North",
"Seaford ",
"Langwarrin",
"Parkdale")
filters=list("SAL_NAME_2021"=c("Frankston",
filters=list("SAL_NAME_2021"=c("Frankston",
"Frankston South",
"Frankston North",
"Seaford ",
"Langwarrin",
"Parkdale"),
"STATE_NAME_2021"=c("Victoria")
)
year="2021"
aggregation="SA1_CODE_2021"
library(aussiemaps)
source("~/GitHub/aussiemaps/R/internal.R")
filter_table <- list_structure(year,filters) |>
select(-matches("AREA_ALBERS_SQKM")) |>
select(-matches("\\."))
library(aussiemaps)
library(arrow)
library(sf)
filter_table <- list_structure(year,filters) |>
select(-matches("AREA_ALBERS_SQKM")) |>
select(-matches("\\."))
library(tidyverse)
filter_table <- list_structure(year,filters) |>
select(-matches("AREA_ALBERS_SQKM")) |>
select(-matches("\\."))
cache_dir  <- find_maps_cache()
file_regex <- str_c(year,"_[A-Z]{1}")
repo_base      <- get_repo_files() |>
mutate(across(c("file_name"), ~ str_remove_all(.x,"\\.zip"))) |>
select(any_of("file_name"))
library(fs)
cache_dir  <- find_maps_cache()
file_regex <- str_c(year,"_[A-Z]{1}")
repo_base      <- get_repo_files() |>
mutate(across(c("file_name"), ~ str_remove_all(.x,"\\.zip"))) |>
select(any_of("file_name"))
library(lubridate)
repo_base      <- get_repo_files() |>
mutate(across(c("file_name"), ~ str_remove_all(.x,"\\.zip"))) |>
select(any_of("file_name"))
library(piggyback)
repo_base      <- get_repo_files() |>
mutate(across(c("file_name"), ~ str_remove_all(.x,"\\.zip"))) |>
select(any_of("file_name"))
repo      <- repo_base |>
filter(if_any(c("file_name"), ~ str_detect(.x,file_regex)))   |>
pull()
state_col <- colnames(filter_table)[str_detect(colnames(filter_table),"STATE|STE")]
state_col <- state_col[str_detect(state_col,"NAME")]
required_states <- filter_table |>
select(all_of(c(state_col))) |>
distinct() |>
mutate(across(all_of(as.vector(state_col)), ~ str_replace_all(.x," ","\\."))) |>
mutate(across(all_of(as.vector(state_col)), ~ str_c(year,"_",.x))) |>
filter(if_any(all_of(as.vector(state_col)), ~ .x %in% repo))           |>
pull()
data_sf <- NULL
for(repo_i in required_states){
data_i <- suppressMessages(suppressWarnings(load_aussiemaps_gpkg(repo_i,filter_table))) |>
select(-matches("AREA_ALBERS_SQKM")) |>
select(-matches("\\."))
data_sf <- bind_rows(data_sf,data_i)
}
library(rgdal)
for(repo_i in required_states){
data_i <- suppressMessages(suppressWarnings(load_aussiemaps_gpkg(repo_i,filter_table))) |>
select(-matches("AREA_ALBERS_SQKM")) |>
select(-matches("\\."))
data_sf <- bind_rows(data_sf,data_i)
}
rm(data_i)
aggregation_prefix <- str_extract(aggregation,"^[^_]*")
aggregation_suffix <- str_extract(aggregation,"[0-9]{4}")
aggregation  <- repo_base |>
filter(if_any(c("file_name"), ~ str_detect(.x,aggregation_prefix))) |>
filter(if_any(c("file_name"), ~ str_detect(.x,as.character(aggregation_suffix)))) |>
filter(if_any(c("file_name"), ~ str_detect(.x,"CODE"))) |>
head(1) |>
pull()
aggregation
aggregation <- as.vector(aggregation)
aggregation
external_territories <- any(str_detect(required_states,"Other"))
if(external_territories){
data_sf_external  <- data_sf |> filter(if_any(as.vector(state_col), ~ str_detect(.x,"Other")))
data_sf           <- data_sf |> filter(if_any(as.vector(state_col), ~ str_detect(.x,"Other"),TRUE))
}
cols_to_keep <-filter_table |>
mutate(across(everything(), as.character)) |>
select(-any_of(c("id","area","Year"))) |>
pivot_longer(-any_of(aggregation),values_to = "value",names_to = "geo_unit") |>
distinct() |>
group_by(across(all_of(c(aggregation,"geo_unit")))) |>
summarise(n=n(),.groups="drop") |>
group_by(across(all_of(c("geo_unit")))) |>
summarise(n=mean(n),.groups="drop") |>
filter(if_any(c("n"), ~ .x==1)) |>
select(any_of("geo_unit")) |>
distinct() |>
pull()
cols_to_keep
area <- get_map(filters=list("SAL_NAME_2021"=c("Frankston",
lk
)
""
aggregation=c("SA1_CODE_2021","SAL_NAME_2021")
aggregation <- as.vector(aggregation)
for(i in 1:length(aggregation)){
aggregation_prefix <- str_extract(aggregation[i],"^[^_]*")
aggregation_suffix <- str_extract(aggregation[i],"[0-9]{4}")
aggregation[i]  <- repo_base |>
filter(if_any(c("file_name"), ~ str_detect(.x,aggregation_prefix))) |>
filter(if_any(c("file_name"), ~ str_detect(.x,as.character(aggregation_suffix)))) |>
filter(if_any(c("file_name"), ~ str_detect(.x,"CODE"))) |>
head(1) |>
pull()
}
aggregation
cols_to_keep <-filter_table |>
mutate(across(everything(), as.character)) |>
select(-any_of(c("id","area","Year"))) |>
pivot_longer(-any_of(aggregation),values_to = "value",names_to = "geo_unit") |>
distinct() |>
group_by(across(all_of(c(aggregation,"geo_unit")))) |>
summarise(n=n(),.groups="drop") |>
group_by(across(all_of(c("geo_unit")))) |>
summarise(n=mean(n),.groups="drop") |>
filter(if_any(c("n"), ~ .x==1)) |>
select(any_of("geo_unit")) |>
distinct() |>
pull()
filter_table
cols_to_keep <-filter_table |>
mutate(across(everything(), as.character)) |>
select(-any_of(c("id","area","Year"))) |>
pivot_longer(-any_of(aggregation),values_to = "value",names_to = "geo_unit") |>
distinct() |>
group_by(across(all_of(c(aggregation,"geo_unit")))) |>
summarise(n=n(),.groups="drop") |>
group_by(across(all_of(c("geo_unit")))) |>
summarise(n=mean(n),.groups="drop") |>
filter(if_any(c("n"), ~ .x==1)) |>
select(any_of("geo_unit")) |>
distinct() |>
pull()
areas_prop <- load_aussiemaps_parquet(aggregation) |>
filter(if_any(c("id"), ~ .x %in% filter_table$id)) |>
collect() |>
group_by(across(c("geo_col")))   |>
summarise(across(any_of("prop"), ~ sum(.x)),.groups="drop")
sf_use_s2(FALSE)
data_sf <- suppressMessages(suppressWarnings(data_sf |>
group_by(across(c(aggregation,cols_to_keep))) |>
summarise(.groups="drop") |>
st_make_valid() |>
st_union(by_feature = TRUE) |>
fill_holes(set_units(smoothing_threshold,"km^2"))
))
library(smoothr)
data_sf <- suppressMessages(suppressWarnings(data_sf |>
group_by(across(c(aggregation,cols_to_keep))) |>
summarise(.groups="drop") |>
st_make_valid() |>
st_union(by_feature = TRUE) |>
fill_holes(set_units(smoothing_threshold,"km^2"))
))
libary(units)
library(units)
data_sf <- suppressMessages(suppressWarnings(data_sf |>
group_by(across(c(aggregation,cols_to_keep))) |>
summarise(.groups="drop") |>
st_make_valid() |>
st_union(by_feature = TRUE) |>
fill_holes(set_units(smoothing_threshold,"km^2"))
))
smoothing_threshold=4
data_sf <- suppressMessages(suppressWarnings(data_sf |>
group_by(across(c(aggregation,cols_to_keep))) |>
summarise(.groups="drop") |>
st_make_valid() |>
st_union(by_feature = TRUE) |>
fill_holes(set_units(smoothing_threshold,"km^2"))
))
cols_to_merge <- colnames(filter_table)
c("SA1_CODE_2021")
aggregation <- as.vector(aggregation)
for(i in 1:length(aggregation)){
aggregation_prefix <- str_extract(aggregation[i],"^[^_]*")
aggregation_suffix <- str_extract(aggregation[i],"[0-9]{4}")
aggregation[i]  <- repo_base |>
filter(if_any(c("file_name"), ~ str_detect(.x,aggregation_prefix))) |>
filter(if_any(c("file_name"), ~ str_detect(.x,as.character(aggregation_suffix)))) |>
filter(if_any(c("file_name"), ~ str_detect(.x,"CODE"))) |>
head(1) |>
pull()
}
external_territories <- any(str_detect(required_states,"Other"))
if(external_territories){
data_sf_external  <- data_sf |> filter(if_any(as.vector(state_col), ~ str_detect(.x,"Other")))
data_sf           <- data_sf |> filter(if_any(as.vector(state_col), ~ str_detect(.x,"Other"),TRUE))
}
cols_to_keep <-filter_table |>
mutate(across(everything(), as.character)) |>
select(-any_of(c("id","area","Year"))) |>
pivot_longer(-any_of(aggregation),values_to = "value",names_to = "geo_unit") |>
distinct() |>
group_by(across(all_of(c(aggregation,"geo_unit")))) |>
summarise(n=n(),.groups="drop") |>
group_by(across(all_of(c("geo_unit")))) |>
summarise(n=mean(n),.groups="drop") |>
filter(if_any(c("n"), ~ .x==1)) |>
select(any_of("geo_unit")) |>
distinct() |>
pull()
data_sf <- NULL
for(repo_i in required_states){
data_i <- suppressMessages(suppressWarnings(load_aussiemaps_gpkg(repo_i,filter_table))) |>
select(-matches("AREA_ALBERS_SQKM")) |>
select(-matches("\\."))
data_sf <- bind_rows(data_sf,data_i)
}
external_territories <- any(str_detect(required_states,"Other"))
if(external_territories){
data_sf_external  <- data_sf |> filter(if_any(as.vector(state_col), ~ str_detect(.x,"Other")))
data_sf           <- data_sf |> filter(if_any(as.vector(state_col), ~ str_detect(.x,"Other"),TRUE))
}
cols_to_keep <-filter_table |>
mutate(across(everything(), as.character)) |>
select(-any_of(c("id","area","Year"))) |>
pivot_longer(-any_of(aggregation),values_to = "value",names_to = "geo_unit") |>
distinct() |>
group_by(across(all_of(c(aggregation,"geo_unit")))) |>
summarise(n=n(),.groups="drop") |>
group_by(across(all_of(c("geo_unit")))) |>
summarise(n=mean(n),.groups="drop") |>
filter(if_any(c("n"), ~ .x==1)) |>
select(any_of("geo_unit")) |>
distinct() |>
pull()
cols_to_merge <- cols_to_merge[!(cols_to_merge %in% c(cols_to_keep,aggregation))]
cols_to_keep <-filter_table |>
mutate(across(everything(), as.character)) |>
select(-any_of(c("id","area","Year"))) |>
pivot_longer(-any_of(aggregation),values_to = "value",names_to = "geo_unit") |>
distinct() |>
group_by(across(all_of(c(aggregation,"geo_unit")))) |>
summarise(n=n(),.groups="drop") |>
group_by(across(all_of(c("geo_unit")))) |>
summarise(n=mean(n),.groups="drop") |>
filter(if_any(c("n"), ~ .x==1)) |>
select(any_of("geo_unit")) |>
distinct() |>
pull()
cols_to_merge
aggregation=c("POA_CODE_2021")
cols_to_keep <-filter_table |>
mutate(across(everything(), as.character)) |>
select(-any_of(c("id","area","Year"))) |>
pivot_longer(-any_of(aggregation),values_to = "value",names_to = "geo_unit") |>
distinct() |>
group_by(across(all_of(c(aggregation,"geo_unit")))) |>
summarise(n=n(),.groups="drop") |>
group_by(across(all_of(c("geo_unit")))) |>
summarise(n=mean(n),.groups="drop") |>
filter(if_any(c("n"), ~ .x==1)) |>
select(any_of("geo_unit")) |>
distinct() |>
pull()
cols_to_keep <- c(cols_to_keep,"Year")
cols_to_merge <- colnames(filter_table)
cols_to_merge <- cols_to_merge[!(cols_to_merge %in% c(cols_to_keep,aggregation))]
cols_to_merge
cols_to_merge <- colnames(filter_table)
cols_to_merge <- cols_to_merge[!(cols_to_merge %in% c(cols_to_keep,aggregation,"id","area"))]
cols_to_merge
data_sf <- suppressMessages(suppressWarnings(data_sf |>
group_by(across(c(aggregation,cols_to_keep))) |>
summarise(across(any_of(cols_to_merge), ~ str_c(.x,collapse=", ")),.groups="drop") |>
st_make_valid() |>
st_union(by_feature = TRUE) |>
fill_holes(set_units(smoothing_threshold,"km^2"))
))
cols_to_merge
data_sf <- NULL
for(repo_i in required_states){
data_i <- suppressMessages(suppressWarnings(load_aussiemaps_gpkg(repo_i,filter_table))) |>
select(-matches("AREA_ALBERS_SQKM")) |>
select(-matches("\\."))
data_sf <- bind_rows(data_sf,data_i)
}
data_sf <- suppressMessages(suppressWarnings(data_sf |>
group_by(across(c(aggregation,cols_to_keep))) |>
summarise(across(any_of(cols_to_merge), ~ str_c(unique(.x),collapse=", ")),.groups="drop") |>
st_make_valid() |>
st_union(by_feature = TRUE) |>
fill_holes(set_units(smoothing_threshold,"km^2"))
))
data_sf <- NULL
for(repo_i in required_states){
data_i <- suppressMessages(suppressWarnings(load_aussiemaps_gpkg(repo_i,filter_table))) |>
select(-matches("AREA_ALBERS_SQKM")) |>
select(-matches("\\."))
data_sf <- bind_rows(data_sf,data_i)
}
data_sf <- suppressMessages(suppressWarnings(data_sf |>
group_by(across(c(aggregation,cols_to_keep))) |>
summarise(across(any_of(cols_to_merge), ~ str_c(distinct(.x),collapse=", ")),.groups="drop") |>
st_make_valid() |>
st_union(by_feature = TRUE) |>
fill_holes(set_units(smoothing_threshold,"km^2"))
))
?str_c
data_sf <- suppressMessages(suppressWarnings(data_sf |>
group_by(across(c(aggregation,cols_to_keep))) |>
summarise(across(any_of(cols_to_merge), ~ str_flatten_comma(.x,collapse=", ")),.groups="drop") |>
st_make_valid() |>
st_union(by_feature = TRUE) |>
fill_holes(set_units(smoothing_threshold,"km^2"))
))
data_sf <- suppressMessages(suppressWarnings(data_sf |>
group_by(across(c(aggregation,cols_to_keep))) |>
summarise(across(any_of(cols_to_merge), ~ str_flatten_comma(.x)),.groups="drop") |>
st_make_valid() |>
st_union(by_feature = TRUE) |>
fill_holes(set_units(smoothing_threshold,"km^2"))
))
data_sf <- suppressMessages(suppressWarnings(data_sf |>
group_by(across(c(aggregation,cols_to_keep))) |>
summarise(,.groups="drop") |>
st_make_valid() |>
st_union(by_feature = TRUE) |>
fill_holes(set_units(smoothing_threshold,"km^2"))
))
data_sf <- suppressMessages(suppressWarnings(data_sf |>
group_by(across(c(aggregation,cols_to_keep))) |>
summarise(.groups="drop") |>
st_make_valid() |>
st_union(by_feature = TRUE) |>
fill_holes(set_units(smoothing_threshold,"km^2"))
))
col_to_keep <- cols_to_keep[1]
col_to_merge <- cols_to_merge[1]
filter_table |>
select(any_of(c(aggregation,cols_to_keep,col_to_merge))) |>
distinct()                                               |>
group_by(across(c(aggregation,cols_to_keep)))            |>
summarise(across(any_of(col_to_merge), ~ str_flatten_comma(.x)))
a <- filter_table |>
select(any_of(c(aggregation,cols_to_keep,col_to_merge))) |>
distinct()                                               |>
group_by(across(c(aggregation,cols_to_keep)))            |>
summarise(across(any_of(col_to_merge), ~ str_flatten_comma(.x)))
View(a)
data_sf |>
left_join(merged_col,by=c(aggregation,cols_to_keep))
merged_col  <- filter_table |>
select(any_of(c(aggregation,cols_to_keep,col_to_merge))) |>
distinct()                                               |>
group_by(across(c(aggregation,cols_to_keep)))            |>
summarise(across(any_of(col_to_merge), ~ str_flatten_comma(.x)))
data_sf |>
left_join(merged_col,by=c(aggregation,cols_to_keep))
data_sf <- data_sf |>
left_join(merged_col,by=c(aggregation,cols_to_keep))
data_sf <- NULL
for(repo_i in required_states){
data_i <- suppressMessages(suppressWarnings(load_aussiemaps_gpkg(repo_i,filter_table))) |>
select(-matches("AREA_ALBERS_SQKM")) |>
select(-matches("\\."))
data_sf <- bind_rows(data_sf,data_i)
}
data_sf <- suppressMessages(suppressWarnings(data_sf |>
group_by(across(c(aggregation,cols_to_keep))) |>
summarise(.groups="drop") |>
st_make_valid() |>
st_union(by_feature = TRUE) |>
fill_holes(set_units(smoothing_threshold,"km^2"))
))
for(col_to_merge  in cols_to_merge){
merged_col  <- filter_table |>
select(any_of(c(aggregation,cols_to_keep,col_to_merge))) |>
distinct()                                               |>
group_by(across(c(aggregation,cols_to_keep)))            |>
summarise(across(any_of(col_to_merge), ~ str_flatten_comma(.x)))
data_sf <- data_sf |>
left_join(merged_col,by=c(aggregation,cols_to_keep)) |>
relocate(.data$geom,.after=last_col())
}
data_sf <- NULL
for(repo_i in required_states){
data_i <- suppressMessages(suppressWarnings(load_aussiemaps_gpkg(repo_i,filter_table))) |>
select(-matches("AREA_ALBERS_SQKM")) |>
select(-matches("\\."))
data_sf <- bind_rows(data_sf,data_i)
}
data_sf <- suppressMessages(suppressWarnings(data_sf |>
group_by(across(c(aggregation,cols_to_keep))) |>
summarise(.groups="drop") |>
st_make_valid() |>
st_union(by_feature = TRUE) |>
fill_holes(set_units(smoothing_threshold,"km^2"))
))
data_sf <- suppressMessages(suppressWarnings(data_sf |>
left_join(merged_col,by=c(aggregation,cols_to_keep)) |>
relocate("geom",.after=last_col())
))
for(col_to_merge  in cols_to_merge){
merged_col  <- filter_table |>
select(any_of(c(aggregation,cols_to_keep,col_to_merge))) |>
distinct()                                               |>
group_by(across(c(aggregation,cols_to_keep)))            |>
summarise(across(any_of(col_to_merge), ~ str_flatten_comma(.x)))
data_sf <- suppressMessages(suppressWarnings(data_sf |>
left_join(merged_col,by=c(aggregation,cols_to_keep)) |>
relocate("geom",.after=last_col())
))
}
