base <- bind_rows(base,intersects) %>%
mutate(id=row_number())
}else{
base <- base |>  mutate(id=row_number())
}
sa1_nbr <- c(sa1_nbr,nrow(base))
st_write_parquet(base,base_file)
rm(base_renmant,ind,intersects,full_overlap,overlapped,intersected)
# SOS ----
ind <- load_geo(main, layer="section_of_state_2011") %>%
filter(STE_NAME_2011==state) %>%
select(-STE_CODE_2011,-STE_NAME_2011)
if(any(str_detect(colnames(ind),"shape"))) {ind <- ind |> rename("geom"="shape")}
full_overlap <- full_coverage(base,
bigger=ind,
base_id="id",
bigger_id="SOS_CODE_2011")
overlapped <- full_overlap %>%
distinct(id) %>%
mutate(dummy=TRUE)
base_renmant <- base  %>%
left_join(overlapped,by="id") %>%
filter(is.na(dummy)) %>%
select(-dummy)
if(nrow(base_renmant)>0){
intersects <- intersections(base_renmant,
bigger=ind,
base_id="id",
bigger_id="SOS_CODE_2011",
base_empty_label="SA2_NAME_2011",
bigger_empty_label="SOS_NAME_2011"
)
intersected <- intersects %>%
distinct(id) %>%
mutate(dummy=TRUE)
non_matched <- base_renmant %>%
left_join(intersected,by="id") %>%
filter(is.na(dummy)) %>%
select(-dummy)
}else{
intersects <- base %>% filter(is.null(id))
non_matched <- base %>% filter(is.null(id))
}
base <- base %>%
left_join(full_overlap,by="id") %>%
filter(!is.na(SOS_CODE_2011))
if(nrow(base_renmant)>0){
base <- bind_rows(base,intersects) %>%
mutate(id=row_number())
}else{
base <- base |>  mutate(id=row_number())
}
sa1_nbr <- c(sa1_nbr,nrow(base))
st_write_parquet(base,base_file)
rm(base_renmant,ind,intersects,full_overlap,overlapped,intersected)
# SOSR ----
ind <- load_geo(main, layer="section_of_state_range_2011") %>%
filter(STE_NAME_2011==state) %>%
select(-STE_CODE_2011,-STE_NAME_2011)
if(any(str_detect(colnames(ind),"shape"))) {ind <- ind |> rename("geom"="shape")}
full_overlap <- full_coverage(base,
bigger=ind,
base_id="id",
bigger_id="SOSR_CODE_2011")
overlapped <- full_overlap %>%
distinct(id) %>%
mutate(dummy=TRUE)
base_renmant <- base  %>%
left_join(overlapped,by="id") %>%
filter(is.na(dummy)) %>%
select(-dummy)
if(nrow(base_renmant)>0){
intersects <- intersections(base_renmant,
bigger=ind,
base_id="id",
bigger_id="SOSR_CODE_2011",
base_empty_label="SA2_NAME_2011",
bigger_empty_label="SOSR_NAME_2011"
)
intersected <- intersects %>%
distinct(id) %>%
mutate(dummy=TRUE)
non_matched <- base_renmant %>%
left_join(intersected,by="id") %>%
filter(is.na(dummy)) %>%
select(-dummy)
}else{
intersects <- base %>% filter(is.null(id))
non_matched <- base %>% filter(is.null(id))
}
base <- base %>%
left_join(full_overlap,by="id") %>%
filter(!is.na(SOSR_CODE_2011))
if(nrow(base_renmant)>0){
base <- bind_rows(base,intersects) %>%
mutate(id=row_number())
}else{
base <- base |>  mutate(id=row_number())
}
sa1_nbr <- c(sa1_nbr,nrow(base))
st_write_parquet(base,base_file)
rm(base_renmant,ind,intersects,full_overlap,overlapped,intersected)
#Tourism Regions -----
ind <- load_geo(nonabs, layer="tourism_region_2011") %>%
filter(STE_NAME_2011==state) %>%
select(-STE_CODE_2011,-STE_NAME_2011)
if(nrow(ind)>0){
if(any(str_detect(colnames(ind),"shape"))) {ind <- ind |> rename("geom"="shape")}
full_overlap <- full_coverage(base,
bigger=ind,
base_id="id",
bigger_id="TR_CODE_2011")
if(!is.null(full_overlap)){
overlapped <- full_overlap %>%
distinct(id) %>%
mutate(dummy=TRUE)
base_renmant <- base  %>%
left_join(overlapped,by="id") %>%
filter(is.na(dummy)) %>%
select(-dummy)
if(nrow(base_renmant)>0){
intersects <- intersections(base_renmant,
bigger=ind,
base_id="id",
bigger_id="TR_CODE_2011",
base_empty_label="SA2_NAME_2011",
bigger_empty_label="TR_NAME_2011"
)
intersected <- intersects %>%
distinct(id) %>%
mutate(dummy=TRUE)
non_matched <- base_renmant %>%
left_join(intersected,by="id") %>%
filter(is.na(dummy)) %>%
select(-dummy)
}else{
intersects <- base %>% filter(is.null(id))
non_matched <- base %>% filter(is.null(id))
}
base <- base %>%
left_join(full_overlap,by="id") %>%
filter(!is.na(TR_CODE_2011))
if(nrow(base_renmant)>0){
base <- bind_rows(base,intersects) %>%
mutate(id=row_number())
}else{
base <- base |>  mutate(id=row_number())
}
sa1_nbr <- c(sa1_nbr,nrow(base))
}
st_write_parquet(base,base_file)
rm(base_renmant,ind,intersects,full_overlap,overlapped,intersected)
}
base |>
leaflet() |>
addTiles() |>
addPolygons()
ba |>
leaflet() |>
addTiles() |>
addPolygons()
base |>
leaflet() |>
addTiles() |>
addPolygons()
ba <- b
ba <- base
# CED ----
if(exists("ceds_2011_out")){
base<-base %>%
left_join(ceds_2011_out,by="SA3_NAME_2011")
}else{
library(auspol)
divisions <- list_divisions(filters=list(StateAb=str_to_upper(state_short))) %>%
filter(`2010`) %>%
mutate(CED_NAME_2011=str_to_lower(DivisionNm),
CED_NAME_2011 = str_squish(CED_NAME_2011)) |>
distinct(CED_NAME_2011,DivisionNm)
ind <- load_geo(nonabs, layer="commonwealth_electoral_division_2011") %>%
mutate(CED_NAME_2011=str_to_lower(CED_NAME_2011),
CED_NAME_2011 = str_squish(CED_NAME_2011)) |>
left_join(divisions,by="CED_NAME_2011") |>
filter(!is.na(DivisionNm)) |>
mutate(CED_NAME_2011=DivisionNm,.keep="unused")
if(any(str_detect(colnames(ind),"shape"))) {ind <- ind |> rename("geom"="shape")}
full_overlap <- full_coverage(base,
bigger=ind,
base_id="id",
bigger_id="CED_CODE_2011")
overlapped <- full_overlap %>%
distinct(id) %>%
mutate(dummy=TRUE)
base_renmant <- base  %>%
left_join(overlapped,by="id") %>%
filter(is.na(dummy)) %>%
select(-dummy)
if(nrow(base_renmant)>0){
intersects <- intersections(base_renmant,
bigger=ind,
base_id="id",
bigger_id="CED_CODE_2011",
base_empty_label="SA2_NAME_2011",
bigger_empty_label="CED_NAME_2011"
)
intersected <- intersects %>%
distinct(id) %>%
mutate(dummy=TRUE)
non_matched <- base_renmant %>%
left_join(intersected,by="id") %>%
filter(is.na(dummy)) %>%
select(-dummy)
}else{
intersects <- base %>% filter(is.null(id))
non_matched <- base %>% filter(is.null(id))
}
base <- base %>%
left_join(full_overlap,by="id") %>%
filter(!is.na(CED_CODE_2011))
if(nrow(base_renmant)>0){
base <- bind_rows(base,intersects) %>%
mutate(id=row_number())
}else{
base <- base |>  mutate(id=row_number())
}
sa1_nbr <- c(sa1_nbr,nrow(base))
st_write_parquet(base,base_file)
rm(base_renmant,ind,intersects,full_overlap,overlapped,intersected)
}
st_write_parquet(base,base_file)
sa1_nbr <- c(sa1_nbr,nrow(base))
rm(base_renmant,ced2021,intersects,full_overlap)
base |>
leaflet() |>
addTiles() |>
addPolygons()
ba <- base
#LGAs ----
ind <- load_geo(nonabs, layer="local_government_area_2011") %>%
filter(STE_NAME_2011==state) %>%
select(-STE_CODE_2011,-STE_NAME_2011)
if(any(str_detect(colnames(ind),"shape"))) {ind <- ind |> rename("geom"="shape")}
full_overlap <- full_coverage(base,
bigger=ind,
base_id="id",
bigger_id="LGA_CODE_2011")
overlapped <- full_overlap %>%
distinct(id) %>%
mutate(dummy=TRUE)
base_renmant <- base  %>%
left_join(overlapped,by="id") %>%
filter(is.na(dummy)) %>%
select(-dummy)
if(nrow(base_renmant)>0){
intersects <- intersections(base_renmant,
bigger=ind,
base_id="id",
bigger_id="LGA_CODE_2011",
base_empty_label="SA2_NAME_2011",
bigger_empty_label="LGA_NAME_2011"
)
intersected <- intersects %>%
distinct(id) %>%
mutate(dummy=TRUE)
non_matched <- base_renmant %>%
left_join(intersected,by="id") %>%
filter(is.na(dummy)) %>%
select(-dummy)
}else{
intersects <- base %>% filter(is.null(id))
non_matched <- base %>% filter(is.null(id))
}
base <- base %>%
left_join(full_overlap,by="id") %>%
filter(!is.na(LGA_CODE_2011))
if(nrow(base_renmant)>0){
base <- bind_rows(base,intersects) %>%
mutate(id=row_number())
}else{
base <- base |>  mutate(id=row_number())
}
sa1_nbr <- c(sa1_nbr,nrow(base))
st_write_parquet(base,base_file)
rm(base_renmant,ind,intersects,full_overlap,overlapped,intersected)
base |>
leaflet() |>
addTiles() |>
addPolygons()
ba <- base
#POAS ----
library(auscensus)
ind <- load_geo(nonabs, layer="post_code_area_2011") %>%
filter(POA_CODE_2011 %in% as.character(poas_state))
if(any(str_detect(colnames(ind),"shape"))) {ind <- ind |> rename("geom"="shape")}
full_overlap <- full_coverage(base,
bigger=ind,
base_id="id",
bigger_id="POA_CODE_2011")
overlapped <- full_overlap %>%
distinct(id) %>%
mutate(dummy=TRUE)
base_renmant <- base  %>%
left_join(overlapped,by="id") %>%
filter(is.na(dummy)) %>%
select(-dummy)
if(nrow(base_renmant)>0){
intersects <- intersections(base_renmant,
bigger=ind,
base_id="id",
bigger_id="POA_CODE_2011",
base_empty_label="SA2_NAME_2011",
bigger_empty_label="POA_NAME_2011"
)
intersected <- intersects %>%
distinct(id) %>%
mutate(dummy=TRUE)
non_matched <- base_renmant %>%
left_join(intersected,by="id") %>%
filter(is.na(dummy)) %>%
select(-dummy)
}else{
intersects <- base %>% filter(is.null(id))
non_matched <- base %>% filter(is.null(id))
}
base <- base %>%
left_join(full_overlap,by="id") %>%
filter(!is.na(POA_CODE_2011))
if(nrow(base_renmant)>0){
base <- bind_rows(base,intersects) %>%
mutate(id=row_number())
}else{
base <- base |>  mutate(id=row_number())
}
sa1_nbr <- c(sa1_nbr,nrow(base))
st_write_parquet(base,base_file)
rm(base_renmant,ind,intersects,full_overlap,overlapped,intersected)
base |>
leaflet() |>
addTiles() |>
addPolygons()
base <- ba
base |>
leaflet() |>
addTiles() |>
addPolygons()
ind <- load_geo(nonabs, layer="local_government_area_2011") %>%
filter(STE_NAME_2011==state) %>%
select(-STE_CODE_2011,-STE_NAME_2011)
base |>
leaflet() |>
addTiles() |>
addPolygons()
base
ind <- load_geo(nonabs, layer="state_suburb_2011") %>%
filter(STE_NAME_2011==state) %>%
select(-STE_CODE_2011,-STE_NAME_2011)
if(any(str_detect(colnames(ind),"shape"))) {ind <- ind |> rename("geom"="shape")}
full_overlap <- full_coverage(base,
bigger=ind,
base_id="id",
bigger_id="SSC_CODE_2011")
full_overlap
overlapped <- full_overlap %>%
distinct(id) %>%
mutate(dummy=TRUE)
base_renmant <- base  %>%
left_join(overlapped,by="id") %>%
filter(is.na(dummy)) %>%
select(-dummy)
intersects <- intersections(base_renmant,
bigger=ind,
base_id="id",
bigger_id="SSC_CODE_2011",
base_empty_label="SA2_NAME_2011",
bigger_empty_label="SSC_NAME_2011"
)
non_matched <- base_renmant %>%
left_join(intersected,by="id") %>%
filter(is.na(dummy)) %>%
select(-dummy)
intersected <- intersects %>%
distinct(id) %>%
mutate(dummy=TRUE)
non_matched <- base_renmant %>%
left_join(intersected,by="id") %>%
filter(is.na(dummy)) %>%
select(-dummy)
base <- base %>%
left_join(full_overlap,by="id") %>%
filter(!is.na(SSC_CODE_2011))
base <-  bind_rows(base,intersects) |>  mutate(id=row_number())
base |>
leaflet() |>
addTiles() |>
addPolygons()
base |> distinct(SSC_NAME_2011)
ba <- base
ind <- load_geo(nonabs, layer="post_code_area_2011") %>%
filter(POA_CODE_2011 %in% as.character(poas_state))
if(any(str_detect(colnames(ind),"shape"))) {ind <- ind |> rename("geom"="shape")}
base <- base |> mutate(id=row_number())
full_overlap <- full_coverage(base,
bigger=ind,
base_id="id",
bigger_id="POA_CODE_2011")
full_overlap
overlapped <- full_overlap %>%
distinct(id) %>%
mutate(dummy=TRUE)
base_renmant <- base  %>%
left_join(overlapped,by="id") %>%
filter(is.na(dummy)) %>%
select(-dummy)
intersects <- intersections(base_renmant,
bigger=ind,
base_id="id",
bigger_id="POA_CODE_2011",
base_empty_label="SA2_NAME_2011",
bigger_empty_label="POA_NAME_2011"
)
intersected <- intersects %>%
distinct(id) %>%
mutate(dummy=TRUE)
non_matched <- base_renmant %>%
left_join(intersected,by="id") %>%
filter(is.na(dummy)) %>%
select(-dummy)
non_matched
base <- base %>%
left_join(full_overlap,by="id") %>%
filter(!is.na(POA_CODE_2011))
base <- bind_rows(base,intersects,non_matched) %>%
mutate(id=row_number())
base |> filter(is.na(POA_CODE_2011))
poa |>
leaflet() |>
addTiles() |>
addPolygons()
ind |>
leaflet() |>
addTiles() |>
addPolygons()
base |>
replace_na(list(POA_CODE_2011="NA",POA_NAME_2011="NA"))
base <-
base |>
replace_na(list(POA_CODE_2011="No POA",POA_NAME_2011="No POA"))
base <- base[st_is(base |> st_make_valid(),c("POLYGON","MULTIPOLYGON")),]
base <- st_cast(base,"POLYGON")
base <- bind_rows(data_base |> select(-any_of(c("id"))),
base |>  select(-any_of(c("id"))))
st_write(base,here("data-raw",str_c("2011_",state,".gpkg")),append = FALSE,delete_dsn = TRUE)
dir_create(here("data-raw","processed"))
rm(list=ls())
source(here("data-raw","aux_save.R"))
files <- dir_ls(here("data-raw"),regexp = "2011.*gpkg$")
geo_structure <- tibble()
files <- dir_ls(here("data-raw"),regexp = "2011.*gpkg$")
geo_structure <- tibble()
for(file in files){
shapes <- st_read(file)
shapes$area <- st_area(shapes)
if(str_detect(file,"Tasmania")){
shapes <- shapes |> mutate(id=str_c(STE_NAME_2011,"-",row_number()))
st_write(shape,file,delete_dsn=TRUE)
}
shapes <- shapes %>% st_drop_geometry()
geo_structure <- bind_rows(geo_structure,shapes)
}
geo_structure <- tibble()
for(file in files){
shapes <- st_read(file)
shapes$area <- st_area(shapes)
if(str_detect(file,"Tasmania")){
shapes <- shapes |> mutate(id=str_c(STE_CODE_2011,"-",row_number()))
st_write(shapes,file,delete_dsn=TRUE)
}
shapes <- shapes %>% st_drop_geometry()
geo_structure <- bind_rows(geo_structure,shapes)
}
geo_structure <- geo_structure %>%
mutate(id=str_c(STE_CODE_2011,"-",id)) %>%
relocate(id,.before=1)
save_zip_parquet(geo_structure,"2011_structure",here("data-raw","processed"))
geo_cols <- colnames(geo_structure)
geo_cols <- geo_cols[str_detect(geo_cols,"CODE")]
attributes <- geo_structure[1,] %>%
select(-any_of(c("area","Year"))) %>%
pivot_longer(-id,names_to="attributes",values_to = "value") %>%
select(attributes) %>%
mutate(Year=2011)
save_zip_parquet(attributes,"2011_attributes",here("data-raw","processed"))
for(geo_col in geo_cols){
struct_i <- geo_structure %>%
filter(!is.na(area)) %>%
select(any_of(c(geo_col,"id","area"))) %>%
rename("col"=geo_col) %>%
group_by(col) %>%
mutate(sum_area = sum(area)) %>%
ungroup() %>%
mutate(prop=if_else(sum_area>units::set_units(0,m^2),
as.numeric(area/sum_area),
0)) %>%
rename(geo_col="col")
save_zip_parquet(struct_i,geo_col,here("data-raw","processed"))
}
for(file in files){
save_zip_gpkg(file,here("data-raw"),here("data-raw","processed"))
}
tas <- st_read(here("data-raw","2011_Tasmania.gpkg"))
tas
tas |> st_union()
tas <- st_read(here("data-raw","2011_Tasmania.gpkg"))
