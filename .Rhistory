#map|> st_drop_geometry() |> count(POA_CODE_2021) |> filter(is.na(POA_CODE_2021))
#map |> st_drop_geometry() |> filter(is.na(POA_CODE_2021)) |> distinct(SAL_NAME_2021) |> clipr::write_clip()
#all postcodes covered
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure  <- bind_rows(geo_structure,
map |> st_drop_geometry())
### South Australia ----
file <- files[6]
map <- st_read(file) |>
mutate(id=str_c(STATE_CODE_2021,"-",row_number()))
map$area <- st_area(map)
#map|> st_drop_geometry() |> count(POA_CODE_2021) |> filter(is.na(POA_CODE_2021))
#map |> st_drop_geometry() |> filter(is.na(POA_CODE_2021)) |> distinct(SAL_NAME_2021) |> clipr::write_clip()
#all postcodes covered
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure  <- bind_rows(geo_structure,
map |> st_drop_geometry())
### Tasmania ----
file <- files[7]
map <- st_read(file) |>
mutate(id=str_c(STATE_CODE_2021,"-",row_number()))
map$area <- st_area(map)
#map|> st_drop_geometry() |> count(POA_CODE_2021) |> filter(is.na(POA_CODE_2021))
#map |> st_drop_geometry() |> filter(is.na(POA_CODE_2021)) |> distinct(SAL_NAME_2021) |> clipr::write_clip()
#all postcodes covered
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure  <- bind_rows(geo_structure,
map |> st_drop_geometry())
### Victoria ----
file <- files[8]
map <- st_read(file) |>
mutate(id=str_c(STATE_CODE_2021,"-",row_number()))
map$area <- st_area(map)
#map|> st_drop_geometry() |> count(POA_CODE_2021) |> filter(is.na(POA_CODE_2021))
#map |> st_drop_geometry() |> filter(is.na(POA_CODE_2021)) |> distinct(SAL_NAME_2021) |> clipr::write_clip()
#all postcodes covered
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure  <- bind_rows(geo_structure,
map |> st_drop_geometry())
### WA
nsw <- st_read(here("data-raw","2021_New South Wales.gpkg"))
half_way <- floor(3*nrow(nsw)/4)
nsw1 <- nsw[1:half_way,]
nsw2 <- nsw[(half_way+1):nrow(nsw),]
st_write(nsw1,here("data-raw","2021_New South Wales 1.gpkg"))
st_write(nsw2,here("data-raw","2021_New South Wales 2.gpkg"))
save_zip_gpkg(here("data-raw","2021_New South Wales 1.gpkg"),
here("data-raw"),
here("data-raw","processed"))
save_zip_gpkg(here("data-raw","2021_New South Wales 2.gpkg"),
here("data-raw"),
here("data-raw","processed"))
### Correct save, get prop tables -----
source(here("data-raw","aux_save.R"))
source(here("data-raw","functions.R"))
files <- dir_ls(here("data-raw"),regexp = "gpkg")
geo_structure <- NULL
### ACT-----
file <- files[1]
map <- st_read(file) |>
mutate(id=str_c(STATE_CODE_2021,"-",row_number()))
map$area <- st_area(map)
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure <- map |> st_drop_geometry()
#### NSW ----
file <- files[2]
map <- st_read(file) |>
mutate(id=str_c(STATE_CODE_2021,"-",row_number()))
map$area <- st_area(map)
map|> st_drop_geometry() |> count(POA_CODE_2021) |> filter(is.na(POA_CODE_2021))
map <- map |> mutate(POA_CODE_2021=case_when(
is.na(POA_CODE_2021) & SAL_NAME_2021=="Cottonvale" ~ "4375",
TRUE ~ POA_CODE_2021),
POA_NAME_2021=POA_CODE_2021)
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure  <- bind_rows(geo_structure,
map |> st_drop_geometry())
### NT ----
file <- files[3]
map <- st_read(file) |>
mutate(id=str_c(STATE_CODE_2021,"-",row_number()))
map$area <- st_area(map)
#map|> st_drop_geometry() |> count(POA_CODE_2021) |> filter(is.na(POA_CODE_2021))
#map |> st_drop_geometry() |> filter(is.na(POA_CODE_2021)) |> distinct(SAL_NAME_2021) |> clipr::write_clip()
nt_postcodes <- tibble::tribble(
~SAL_NAME_2021, ~postcode,
"Newcastle Waters",    "0862",
"Larrimah",    "0852",
"Daly Waters",    "0852",
"Koolpinyah",    "0822",
"Araluen",    "0870",
"Mataranka",    "0852",
"Kaltukatjara",    "0872",
"Ilparpa",    "0873",
"Maranunga",    "0822",
"Nauiyu",    "0822",
"Gunbalanya",    "0822",
"Wagait Beach",    "0822",
"Sandover",    "0872",
"West Arnhem",    "0822",
"Lajamanu",    "0852",
"Bynoe Harbour",    "0822",
"Dundee Beach",    "0840",
"Dundee Downs",    "0840",
"Dundee Forest",    "0840",
"Micket Creek",    "0822",
"Van Diemen Gulf",    "0822",
"Kakadu",    "0822"
)
map <- map |>
left_join(nt_postcodes,by="SAL_NAME_2021") |>
mutate(POA_CODE_2021=case_when(
is.na(POA_CODE_2021)  ~ postcode,
TRUE ~ POA_CODE_2021),
POA_NAME_2021=POA_CODE_2021) |>
select(-postcode)
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure  <- bind_rows(geo_structure,
map |> st_drop_geometry())
### Other Territories ----
file <- files[4]
map <- st_read(file) |>
mutate(id=str_c(STATE_CODE_2021,"-",row_number()))
map$area <- st_area(map)
#map|> st_drop_geometry() |> count(POA_CODE_2021) |> filter(is.na(POA_CODE_2021))
#map |> st_drop_geometry() |> filter(is.na(POA_CODE_2021)) |> distinct(SAL_NAME_2021) |> clipr::write_clip()
#all postcodes covered
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure  <- bind_rows(geo_structure,
map |> st_drop_geometry())
### Queensland ----
file <- files[5]
map <- st_read(file) |>
mutate(id=str_c(STATE_CODE_2021,"-",row_number()))
map$area <- st_area(map)
#map|> st_drop_geometry() |> count(POA_CODE_2021) |> filter(is.na(POA_CODE_2021))
#map |> st_drop_geometry() |> filter(is.na(POA_CODE_2021)) |> distinct(SAL_NAME_2021) |> clipr::write_clip()
#all postcodes covered
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure  <- bind_rows(geo_structure,
map |> st_drop_geometry())
### South Australia ----
file <- files[6]
map <- st_read(file) |>
mutate(id=str_c(STATE_CODE_2021,"-",row_number()))
map$area <- st_area(map)
#map|> st_drop_geometry() |> count(POA_CODE_2021) |> filter(is.na(POA_CODE_2021))
#map |> st_drop_geometry() |> filter(is.na(POA_CODE_2021)) |> distinct(SAL_NAME_2021) |> clipr::write_clip()
#all postcodes covered
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure  <- bind_rows(geo_structure,
map |> st_drop_geometry())
### Tasmania ----
file <- files[7]
map <- st_read(file) |>
mutate(id=str_c(STATE_CODE_2021,"-",row_number()))
map$area <- st_area(map)
#map|> st_drop_geometry() |> count(POA_CODE_2021) |> filter(is.na(POA_CODE_2021))
#map |> st_drop_geometry() |> filter(is.na(POA_CODE_2021)) |> distinct(SAL_NAME_2021) |> clipr::write_clip()
#all postcodes covered
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure  <- bind_rows(geo_structure,
map |> st_drop_geometry())
### Victoria ----
file <- files[8]
map <- st_read(file) |>
mutate(id=str_c(STATE_CODE_2021,"-",row_number()))
map$area <- st_area(map)
#map|> st_drop_geometry() |> count(POA_CODE_2021) |> filter(is.na(POA_CODE_2021))
#map |> st_drop_geometry() |> filter(is.na(POA_CODE_2021)) |> distinct(SAL_NAME_2021) |> clipr::write_clip()
#all postcodes covered
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure  <- bind_rows(geo_structure,
map |> st_drop_geometry())
### WA
geo_structure |> distinct(STATE_NAME_2021)
### Correct save, get prop tables -----
source(here("data-raw","aux_save.R"))
source(here("data-raw","functions.R"))
files <- dir_ls(here("data-raw"),regexp = "gpkg")
geo_structure <- NULL
### ACT-----
file <- files[1]
map <- st_read(file) |>
mutate(id=str_c(STATE_CODE_2021,"-",row_number()))
map$area <- st_area(map)
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure <- map |> st_drop_geometry()
#### NSW ----
file <- files[2]
map <- st_read(file) |>
mutate(id=str_c(STATE_CODE_2021,"-",row_number()))
map$area <- st_area(map)
map|> st_drop_geometry() |> count(POA_CODE_2021) |> filter(is.na(POA_CODE_2021))
map <- map |> mutate(POA_CODE_2021=case_when(
is.na(POA_CODE_2021) & SAL_NAME_2021=="Cottonvale" ~ "4375",
TRUE ~ POA_CODE_2021),
POA_NAME_2021=POA_CODE_2021)
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure  <- bind_rows(geo_structure,
map |> st_drop_geometry())
### Correct save, get prop tables -----
source(here("data-raw","aux_save.R"))
source(here("data-raw","functions.R"))
files <- dir_ls(here("data-raw"),regexp = "gpkg")
geo_structure <- NULL
### ACT-----
file <- files[1]
map <- st_read(file) |>
mutate(id=str_c(STATE_CODE_2021,"-",row_number()))
map$area <- st_area(map)
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure <- map |> st_drop_geometry()
#### NSW ----
file <- files[2]
map <- st_read(file) |>
mutate(id=str_c(STATE_CODE_2021,"-",row_number()))
map$area <- st_area(map)
map|> st_drop_geometry() |> count(POA_CODE_2021) |> filter(is.na(POA_CODE_2021))
map <- map |> mutate(POA_CODE_2021=case_when(
is.na(POA_CODE_2021) & SAL_NAME_2021=="Cottonvale" ~ "4375",
TRUE ~ POA_CODE_2021),
POA_NAME_2021=POA_CODE_2021)
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure  <- bind_rows(geo_structure,
map |> st_drop_geometry())
### Correct save, get prop tables -----
source(here("data-raw","aux_save.R"))
source(here("data-raw","functions.R"))
files <- dir_ls(here("data-raw"),regexp = "gpkg")
geo_structure <- NULL
### ACT-----
file <- files[1]
map <- st_read(file) |>
mutate(id=str_c(STATE_CODE_2021,"-",row_number()))
map$area <- st_area(map)
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure <- map |> st_drop_geometry()
#### NSW ----
file <- files[2]
map <- st_read(file) |>
mutate(id=str_c(STATE_CODE_2021,"-",row_number()))
map$area <- st_area(map)
map|> st_drop_geometry() |> count(POA_CODE_2021) |> filter(is.na(POA_CODE_2021))
map <- map |> mutate(POA_CODE_2021=case_when(
is.na(POA_CODE_2021) & SAL_NAME_2021=="Cottonvale" ~ "4375",
TRUE ~ POA_CODE_2021),
POA_NAME_2021=POA_CODE_2021)
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure  <- bind_rows(geo_structure,
map |> st_drop_geometry())
### NT ----
file <- files[3]
map <- st_read(file) |>
mutate(id=str_c(STATE_CODE_2021,"-",row_number()))
map$area <- st_area(map)
#map|> st_drop_geometry() |> count(POA_CODE_2021) |> filter(is.na(POA_CODE_2021))
#map |> st_drop_geometry() |> filter(is.na(POA_CODE_2021)) |> distinct(SAL_NAME_2021) |> clipr::write_clip()
nt_postcodes <- tibble::tribble(
~SAL_NAME_2021, ~postcode,
"Newcastle Waters",    "0862",
"Larrimah",    "0852",
"Daly Waters",    "0852",
"Koolpinyah",    "0822",
"Araluen",    "0870",
"Mataranka",    "0852",
"Kaltukatjara",    "0872",
"Ilparpa",    "0873",
"Maranunga",    "0822",
"Nauiyu",    "0822",
"Gunbalanya",    "0822",
"Wagait Beach",    "0822",
"Sandover",    "0872",
"West Arnhem",    "0822",
"Lajamanu",    "0852",
"Bynoe Harbour",    "0822",
"Dundee Beach",    "0840",
"Dundee Downs",    "0840",
"Dundee Forest",    "0840",
"Micket Creek",    "0822",
"Van Diemen Gulf",    "0822",
"Kakadu",    "0822"
)
map <- map |>
left_join(nt_postcodes,by="SAL_NAME_2021") |>
mutate(POA_CODE_2021=case_when(
is.na(POA_CODE_2021)  ~ postcode,
TRUE ~ POA_CODE_2021),
POA_NAME_2021=POA_CODE_2021) |>
select(-postcode)
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure  <- bind_rows(geo_structure,
map |> st_drop_geometry())
### Other Territories ----
file <- files[4]
map <- st_read(file) |>
mutate(id=str_c(STATE_CODE_2021,"-",row_number()))
map$area <- st_area(map)
#map|> st_drop_geometry() |> count(POA_CODE_2021) |> filter(is.na(POA_CODE_2021))
#map |> st_drop_geometry() |> filter(is.na(POA_CODE_2021)) |> distinct(SAL_NAME_2021) |> clipr::write_clip()
#all postcodes covered
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure  <- bind_rows(geo_structure,
map |> st_drop_geometry())
### Queensland ----
file <- files[5]
map <- st_read(file) |>
mutate(id=str_c(STATE_CODE_2021,"-",row_number()))
map$area <- st_area(map)
#map|> st_drop_geometry() |> count(POA_CODE_2021) |> filter(is.na(POA_CODE_2021))
#map |> st_drop_geometry() |> filter(is.na(POA_CODE_2021)) |> distinct(SAL_NAME_2021) |> clipr::write_clip()
#all postcodes covered
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure  <- bind_rows(geo_structure,
map |> st_drop_geometry())
### South Australia ----
file <- files[6]
map <- st_read(file) |>
mutate(id=str_c(STATE_CODE_2021,"-",row_number()))
map$area <- st_area(map)
#map|> st_drop_geometry() |> count(POA_CODE_2021) |> filter(is.na(POA_CODE_2021))
#map |> st_drop_geometry() |> filter(is.na(POA_CODE_2021)) |> distinct(SAL_NAME_2021) |> clipr::write_clip()
#all postcodes covered
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure  <- bind_rows(geo_structure,
map |> st_drop_geometry())
### Tasmania ----
file <- files[7]
map <- st_read(file) |>
mutate(id=str_c(STATE_CODE_2021,"-",row_number()))
map$area <- st_area(map)
#map|> st_drop_geometry() |> count(POA_CODE_2021) |> filter(is.na(POA_CODE_2021))
#map |> st_drop_geometry() |> filter(is.na(POA_CODE_2021)) |> distinct(SAL_NAME_2021) |> clipr::write_clip()
#all postcodes covered
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure  <- bind_rows(geo_structure,
map |> st_drop_geometry())
### Victoria ----
file <- files[8]
map <- st_read(file) |>
mutate(id=str_c(STATE_CODE_2021,"-",row_number()))
map$area <- st_area(map)
#map|> st_drop_geometry() |> count(POA_CODE_2021) |> filter(is.na(POA_CODE_2021))
#map |> st_drop_geometry() |> filter(is.na(POA_CODE_2021)) |> distinct(SAL_NAME_2021) |> clipr::write_clip()
#all postcodes covered
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure  <- bind_rows(geo_structure,
map |> st_drop_geometry())
### WA ----
file <- files[9]
map <- st_read(file) |>
mutate(id=str_c(STATE_CODE_2021,"-",row_number()))
map$area <- st_area(map)
#map|> st_drop_geometry() |> count(POA_CODE_2021) |> filter(is.na(POA_CODE_2021))
#map |> st_drop_geometry() |> filter(is.na(POA_CODE_2021)) |> distinct(SAL_NAME_2021) |> clipr::write_clip()
#all postcodes covered
st_write(map,file,append = FALSE,delete_dsn = TRUE)
save_zip_gpkg(file,
here("data-raw"),
here("data-raw","processed"))
geo_structure  <- bind_rows(geo_structure,
map |> st_drop_geometry())
geo_structure |> distinct(STATE_NAME_2021)
#save structure, create proportions ----
geo_structure <- geo_structure |>
relocate(id,.before=1)
save_zip_parquet(geo_structure,"2021_structure",here("data-raw","processed"))
geo_cols <- colnames(geo_structure)
geo_cols <- geo_cols[str_detect(geo_cols,"CODE")]
for(geo_col in geo_cols){
message(geo_col)
struct_i <- geo_structure %>%
filter(!is.na(area)) %>%
select(any_of(c(geo_col,"id","area"))) %>%
rename("col"=geo_col) %>%
group_by(col) %>%
mutate(sum_area = sum(area)) %>%
ungroup() %>%
mutate(prop=if_else(sum_area>units::set_units(0,m^2),
as.numeric(area/sum_area),
0)) %>%
rename(geo_col="col")
save_zip_parquet(struct_i,geo_col,here("data-raw","processed"))
}
nsw <- st_read(here("data-raw","2021_New South Wales.gpkg"))
half_way <- floor(3*nrow(nsw)/4)
nsw1 <- nsw[1:half_way,]
nsw2 <- nsw[(half_way+1):nrow(nsw),]
st_write(nsw1,here("data-raw","2021_New South Wales 1.gpkg"))
st_write(nsw2,here("data-raw","2021_New South Wales 2.gpkg"))
save_zip_gpkg(here("data-raw","2021_New South Wales 1.gpkg"),
here("data-raw"),
here("data-raw","processed"))
save_zip_gpkg(here("data-raw","2021_New South Wales 2.gpkg"),
here("data-raw"),
here("data-raw","processed"))
library(piggyback)
library(here)
library(fs)
library(tidyverse)
files_dir      <- here("data-raw","processed")
repo           <- "carlosyanez/aussiemaps"
version       <- "data"
files <- tibble(path=dir_ls(files_dir),
file=str_remove(path,str_c(files_dir,"/"))) |>
mutate(file_mod=str_replace_all(file," ","."))
set.seed(123)
files <- slice_sample(files,prop=1)
for(file in files$path){
message(file)
#files_list <- files[steps[i-1]:steps[i],]
pb_upload(file,repo,version)
#tryCatch(pb_upload(file=file,repo,version),
#         error=function(e){print(e)})
message("next")
Sys.sleep(60)
}
today <- piggyback::pb_list(repo)
today <- today |> filter(str_detect(file_name,"2021")) |>
filter(lubridate::date(timestamp)==lubridate::today())
today
for(file in files$path){
message(file)
#files_list <- files[steps[i-1]:steps[i],]
pb_upload(file,repo,version)
#tryCatch(pb_upload(file=file,repo,version),
#         error=function(e){print(e)})
message("next")
Sys.sleep(60)
}
# upload catalogue items ---
for(file in files$path){
message(file)
#files_list <- files[steps[i-1]:steps[i],]
pb_upload(file,repo,version)
#tryCatch(pb_upload(file=file,repo,version),
#         error=function(e){print(e)})
message("next")
#Sys.sleep(60)
}
